<!DOCTYPE html>
<html>
<head>
    <title>Twitch chat</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div id="chat">
        <!-- <div class="message" id="msg1">
            <div class="name">
                <h1>
                    son nom
                </h1>
            </div>
            <div class="data">
                <p>ceci est un test</p>
            </div>
        </div> -->

    </div>
</body>
<script>
    var jsonPath = "chat.json";
    var data;
    function fetchJSONData() {
        return fetch(jsonPath)
            .then((res) => {
                if (!res.ok) {
                    throw new Error
                        (`HTTP error! Status: ${res.status}`);
                }
                return res.json();
            })
    }
    window.addEventListener('DOMContentLoaded', (event) => {
        var chat = document.getElementById('chat');

        setInterval(function(){
            fetchJSONData().then((jsonData) => {
                data = jsonData;
            });
            var lastMessage = chat.firstElementChild;
            if (lastMessage == null){
                var lastMessageId = 0;
            } else {
                var lastMessageId = parseInt(lastMessage.id.replace('msg', '')) + 1;
            }
            for (var i = lastMessageId; i < data.length; i++){
                (function(i) {
                
                var message = document.createElement('div');
                message.className = 'message';
                switch (data[i].type){
                    case 'notif':
                        message.classList.add('notif')
                        break;
                    case 'negatif':
                        message.classList.add('negatif')
                        break;
                    case 'subscibe':
                        message.classList.add('subscibe')
                        break;
                    case 'cheer':
                        message.classList.add('cheer')
                        break;
                    case 'raid':
                        message.classList.add('raid')
                        break;
                }
                message.id = 'msg' + i;
                var name = document.createElement('div');
                name.className = 'name';
                var nameH1 = document.createElement('h2');
                nameH1.innerText = data[i].name;
                nameH1.style.color = data[i].name_color;
                name.appendChild(nameH1);
                var dataDiv = document.createElement('div');
                dataDiv.className = 'data';
                var dataP = document.createElement('p');
                var line = document.createElement('hr');
                dataP.innerText = data[i].message;
                dataDiv.appendChild(dataP);
                message.appendChild(name);
                message.appendChild(line);
                message.appendChild(dataDiv);


                message.style.visibility = 'hidden';
               
                chat.insertBefore(message, chat.firstChild);
                var messageHeight = message.offsetHeight;
                chat.removeChild(message);
                message.style.visibility = 'visible';

                var existingMessages = chat.getElementsByClassName('message');
                Array.from(existingMessages).forEach(function(existingMessage) {
                    existingMessage.style.transition = 'transform 0.5s';
                    existingMessage.style.transform = `translateY(${messageHeight}px)`;
                });

                message.style.opacity = '0';
                message.style.transform = 'translateX(100%)';
                chat.insertBefore(message, chat.firstChild);

                setTimeout(function(){
                    message.style.transition = 'opacity 0.5s, transform 0.5s';
                    message.style.opacity = '1';
                    message.style.transform = 'translateY(0)';
                }, 10);

                setTimeout(function() {
                    Array.from(existingMessages).forEach(function(existingMessage) {
                        existingMessage.style.transition = 'transform 0.5s';
                        existingMessage.style.transform = 'translateY(0)';
                    });
                }, 100);

                })(i);
            }
        }, 500);
        
    });
</script>

</html>